import React, { useState, useEffect } from 'react';
import { Trophy, Target, Calendar, CheckCircle, Circle, ChevronRight, Plus, X, Edit2, Trash2, Flame } from 'lucide-react';

const GoalsQuestTracker = () => {
  const [goals, setGoals] = useState([]);
  const [selectedGoal, setSelectedGoal] = useState(null);
  const [selectedQuarter, setSelectedQuarter] = useState(null);
  const [selectedMonth, setSelectedMonth] = useState(null);
  const [selectedWeek, setSelectedWeek] = useState(null);
  const [view, setView] = useState('goals');
  const [showAddModal, setShowAddModal] = useState(false);
  const [newItemName, setNewItemName] = useState('');
  const [currentAddType, setCurrentAddType] = useState('');
  const [streak, setStreak] = useState(0);
  const [totalXP, setTotalXP] = useState(0);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      const goalsData = await window.storage.get('goals-2026');
      const streakData = await window.storage.get('user-streak');
      const xpData = await window.storage.get('user-xp');
      
      if (goalsData) setGoals(JSON.parse(goalsData.value));
      if (streakData) setStreak(parseInt(streakData.value));
      if (xpData) setTotalXP(parseInt(xpData.value));
    } catch (error) {
      console.log('No saved data found, starting fresh');
    }
  };

  const saveData = async (newGoals, newStreak, newXP) => {
    try {
      await window.storage.set('goals-2026', JSON.stringify(newGoals));
      await window.storage.set('user-streak', newStreak.toString());
      await window.storage.set('user-xp', newXP.toString());
    } catch (error) {
      console.error('Failed to save data:', error);
    }
  };

  const addItem = () => {
    if (!newItemName.trim()) return;

    let updatedGoals = [...goals];

    if (currentAddType === 'goal') {
      updatedGoals.push({
        id: Date.now(),
        name: newItemName,
        quarters: []
      });
    } else if (currentAddType === 'quarter' && selectedGoal) {
      const goalIndex = updatedGoals.findIndex(g => g.id === selectedGoal.id);
      updatedGoals[goalIndex].quarters.push({
        id: Date.now(),
        name: newItemName,
        months: []
      });
    } else if (currentAddType === 'month' && selectedQuarter) {
      const goalIndex = updatedGoals.findIndex(g => g.id === selectedGoal.id);
      const quarterIndex = updatedGoals[goalIndex].quarters.findIndex(q => q.id === selectedQuarter.id);
      updatedGoals[goalIndex].quarters[quarterIndex].months.push({
        id: Date.now(),
        name: newItemName,
        weeks: []
      });
    } else if (currentAddType === 'week' && selectedMonth) {
      const goalIndex = updatedGoals.findIndex(g => g.id === selectedGoal.id);
      const quarterIndex = updatedGoals[goalIndex].quarters.findIndex(q => q.id === selectedQuarter.id);
      const monthIndex = updatedGoals[goalIndex].quarters[quarterIndex].months.findIndex(m => m.id === selectedMonth.id);
      updatedGoals[goalIndex].quarters[quarterIndex].months[monthIndex].weeks.push({
        id: Date.now(),
        name: newItemName,
        tasks: []
      });
    } else if (currentAddType === 'task' && selectedWeek) {
      const goalIndex = updatedGoals.findIndex(g => g.id === selectedGoal.id);
      const quarterIndex = updatedGoals[goalIndex].quarters.findIndex(q => q.id === selectedQuarter.id);
      const monthIndex = updatedGoals[goalIndex].quarters[quarterIndex].months.findIndex(m => m.id === selectedMonth.id);
      const weekIndex = updatedGoals[goalIndex].quarters[quarterIndex].months[monthIndex].weeks.findIndex(w => w.id === selectedWeek.id);
      updatedGoals[goalIndex].quarters[quarterIndex].months[monthIndex].weeks[weekIndex].tasks.push({
        id: Date.now(),
        name: newItemName,
        completed: false
      });
    }

    setGoals(updatedGoals);
    saveData(updatedGoals, streak, totalXP);
    setNewItemName('');
    setShowAddModal(false);
  };

  const toggleTask = (taskId) => {
    let updatedGoals = [...goals];
    const goalIndex = updatedGoals.findIndex(g => g.id === selectedGoal.id);
    const quarterIndex = updatedGoals[goalIndex].quarters.findIndex(q => q.id === selectedQuarter.id);
    const monthIndex = updatedGoals[goalIndex].quarters[quarterIndex].months.findIndex(m => m.id === selectedMonth.id);
    const weekIndex = updatedGoals[goalIndex].quarters[quarterIndex].months[monthIndex].weeks.findIndex(w => w.id === selectedWeek.id);
    const taskIndex = updatedGoals[goalIndex].quarters[quarterIndex].months[monthIndex].weeks[weekIndex].tasks.findIndex(t => t.id === taskId);
    
    const task = updatedGoals[goalIndex].quarters[quarterIndex].months[monthIndex].weeks[weekIndex].tasks[taskIndex];
    task.completed = !task.completed;

    let newStreak = streak;
    let newXP = totalXP;

    if (task.completed) {
      newXP += 10;
      const allTasksCompleted = updatedGoals[goalIndex].quarters[quarterIndex].months[monthIndex].weeks[weekIndex].tasks.every(t => t.completed);
      if (allTasksCompleted) {
        newStreak += 1;
        newXP += 50;
      }
    }

    setGoals(updatedGoals);
    setStreak(newStreak);
    setTotalXP(newXP);
    saveData(updatedGoals, newStreak, newXP);
  };

  const calculateProgress = (item, type) => {
    if (type === 'goal') {
      if (!item.quarters.length) return 0;
      const totalQuarters = item.quarters.length;
      const completedQuarters = item.quarters.filter(q => calculateProgress(q, 'quarter') === 100).length;
      return Math.round((completedQuarters / totalQuarters) * 100);
    } else if (type === 'quarter') {
      if (!item.months.length) return 0;
      const totalMonths = item.months.length;
      const completedMonths = item.months.filter(m => calculateProgress(m, 'month') === 100).length;
      return Math.round((completedMonths / totalMonths) * 100);
    } else if (type === 'month') {
      if (!item.weeks.length) return 0;
      const totalWeeks = item.weeks.length;
      const completedWeeks = item.weeks.filter(w => calculateProgress(w, 'week') === 100).length;
      return Math.round((completedWeeks / totalWeeks) * 100);
    } else if (type === 'week') {
      if (!item.tasks.length) return 0;
      const totalTasks = item.tasks.length;
      const completedTasks = item.tasks.filter(t => t.completed).length;
      return Math.round((completedTasks / totalTasks) * 100);
    }
    return 0;
  };

  const openAddModal = (type) => {
    setCurrentAddType(type);
    setShowAddModal(true);
  };

  const getLevel = () => Math.floor(totalXP / 100) + 1;

  const ProgressBar = ({ progress }) => (
    <div className="w-full bg-gray-200 rounded-full h-2 mt-2">
      <div 
        className="bg-green-500 h-2 rounded-full transition-all duration-300"
        style={{ width: `${progress}%` }}
      />
    </div>
  );

  const Header = () => (
    <div className="bg-green-600 text-white p-4 sticky top-0 z-10 shadow-md">
      <div className="flex justify-between items-center max-w-2xl mx-auto">
        <div className="flex items-center gap-2">
          <Trophy className="w-6 h-6" />
          <span className="font-bold text-lg">2026 Goals</span>
        </div>
        <div className="flex items-center gap-4">
          <div className="flex items-center gap-1">
            <Flame className="w-5 h-5 text-orange-400" />
            <span className="font-bold">{streak}</span>
          </div>
          <div className="text-sm">
            <div className="font-bold">Level {getLevel()}</div>
            <div className="text-xs opacity-90">{totalXP} XP</div>
          </div>
        </div>
      </div>
    </div>
  );

  const Card = ({ title, progress, onClick, icon: Icon }) => (
    <div 
      onClick={onClick}
      className="bg-white rounded-lg p-4 shadow-sm border-2 border-gray-200 hover:border-green-500 transition-all cursor-pointer active:scale-95"
    >
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3 flex-1">
          <Icon className="w-6 h-6 text-green-600" />
          <div className="flex-1">
            <h3 className="font-semibold text-gray-800">{title}</h3>
            <ProgressBar progress={progress} />
            <div className="text-xs text-gray-600 mt-1">{progress}% complete</div>
          </div>
        </div>
        <ChevronRight className="w-5 h-5 text-gray-400" />
      </div>
    </div>
  );

  const TaskItem = ({ task, onToggle }) => (
    <div 
      onClick={onToggle}
      className="bg-white rounded-lg p-4 shadow-sm border-2 border-gray-200 hover:border-green-500 transition-all cursor-pointer active:scale-95"
    >
      <div className="flex items-center gap-3">
        {task.completed ? (
          <CheckCircle className="w-6 h-6 text-green-600 flex-shrink-0" />
        ) : (
          <Circle className="w-6 h-6 text-gray-400 flex-shrink-0" />
        )}
        <span className={`flex-1 ${task.completed ? 'line-through text-gray-400' : 'text-gray-800'}`}>
          {task.name}
        </span>
        {task.completed && <span className="text-xs text-green-600 font-bold">+10 XP</span>}
      </div>
    </div>
  );

  const AddButton = ({ onClick, label }) => (
    <button
      onClick={onClick}
      className="w-full bg-green-600 text-white rounded-lg py-3 font-semibold hover:bg-green-700 transition-colors flex items-center justify-center gap-2"
    >
      <Plus className="w-5 h-5" />
      {label}
    </button>
  );

  return (
    <div className="min-h-screen bg-gray-50">
      <Header />
      
      <div className="max-w-2xl mx-auto p-4 pb-20">
        {view === 'goals' && (
          <div className="space-y-3">
            {goals.map(goal => (
              <Card
                key={goal.id}
                title={goal.name}
                progress={calculateProgress(goal, 'goal')}
                onClick={() => {
                  setSelectedGoal(goal);
                  setView('quarters');
                }}
                icon={Trophy}
              />
            ))}
            <AddButton onClick={() => openAddModal('goal')} label="Add New Goal" />
          </div>
        )}

        {view === 'quarters' && selectedGoal && (
          <div className="space-y-3">
            <button 
              onClick={() => {
                setView('goals');
                setSelectedGoal(null);
              }}
              className="text-green-600 font-semibold mb-2 flex items-center gap-1"
            >
              ← Back to Goals
            </button>
            <h2 className="text-xl font-bold text-gray-800 mb-4">{selectedGoal.name}</h2>
            {selectedGoal.quarters.map(quarter => (
              <Card
                key={quarter.id}
                title={quarter.name}
                progress={calculateProgress(quarter, 'quarter')}
                onClick={() => {
                  setSelectedQuarter(quarter);
                  setView('months');
                }}
                icon={Target}
              />
            ))}
            <AddButton onClick={() => openAddModal('quarter')} label="Add Quarterly Quest" />
          </div>
        )}

        {view === 'months' && selectedQuarter && (
          <div className="space-y-3">
            <button 
              onClick={() => {
                setView('quarters');
                setSelectedQuarter(null);
              }}
              className="text-green-600 font-semibold mb-2 flex items-center gap-1"
            >
              ← Back to Quarters
            </button>
            <h2 className="text-xl font-bold text-gray-800 mb-4">{selectedQuarter.name}</h2>
            {selectedQuarter.months.map(month => (
              <Card
                key={month.id}
                title={month.name}
                progress={calculateProgress(month, 'month')}
                onClick={() => {
                  setSelectedMonth(month);
                  setView('weeks');
                }}
                icon={Calendar}
              />
            ))}
            <AddButton onClick={() => openAddModal('month')} label="Add Monthly Target" />
          </div>
        )}

        {view === 'weeks' && selectedMonth && (
          <div className="space-y-3">
            <button 
              onClick={() => {
                setView('months');
                setSelectedMonth(null);
              }}
              className="text-green-600 font-semibold mb-2 flex items-center gap-1"
            >
              ← Back to Months
            </button>
            <h2 className="text-xl font-bold text-gray-800 mb-4">{selectedMonth.name}</h2>
            {selectedMonth.weeks.map(week => (
              <Card
                key={week.id}
                title={week.name}
                progress={calculateProgress(week, 'week')}
                onClick={() => {
                  setSelectedWeek(week);
                  setView('tasks');
                }}
                icon={CheckCircle}
              />
            ))}
            <AddButton onClick={() => openAddModal('week')} label="Add Weekly Target" />
          </div>
        )}

        {view === 'tasks' && selectedWeek && (
          <div className="space-y-3">
            <button 
              onClick={() => {
                setView('weeks');
                setSelectedWeek(null);
              }}
              className="text-green-600 font-semibold mb-2 flex items-center gap-1"
            >
              ← Back to Weeks
            </button>
            <h2 className="text-xl font-bold text-gray-800 mb-4">{selectedWeek.name}</h2>
            {selectedWeek.tasks.map(task => (
              <TaskItem
                key={task.id}
                task={task}
                onToggle={() => toggleTask(task.id)}
              />
            ))}
            <AddButton onClick={() => openAddModal('task')} label="Add Daily Task" />
          </div>
        )}
      </div>

      {showAddModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50 p-4">
          <div className="bg-white rounded-t-2xl sm:rounded-2xl w-full max-w-md p-6 animate-slide-up">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-lg font-bold text-gray-800">
                Add {currentAddType === 'goal' ? 'Goal' : 
                     currentAddType === 'quarter' ? 'Quarterly Quest' :
                     currentAddType === 'month' ? 'Monthly Target' :
                     currentAddType === 'week' ? 'Weekly Target' : 'Daily Task'}
              </h3>
              <button onClick={() => setShowAddModal(false)}>
                <X className="w-6 h-6 text-gray-400" />
              </button>
            </div>
            <input
              type="text"
              value={newItemName}
              onChange={(e) => setNewItemName(e.target.value)}
              placeholder="Enter name..."
              className="w-full border-2 border-gray-300 rounded-lg p-3 mb-4 focus:border-green-500 focus:outline-none"
              autoFocus
              onKeyPress={(e) => e.key === 'Enter' && addItem()}
            />
            <button
              onClick={addItem}
              className="w-full bg-green-600 text-white rounded-lg py-3 font-semibold hover:bg-green-700 transition-colors"
            >
              Add
            </button>
          </div>
        </div>
      )}

      <style jsx>{`
        @keyframes slide-up {
          from {
            transform: translateY(100%);
          }
          to {
            transform: translateY(0);
          }
        }
        .animate-slide-up {
          animation: slide-up 0.3s ease-out;
        }
      `}</style>
    </div>
  );
};

export default GoalsQuestTracker;
